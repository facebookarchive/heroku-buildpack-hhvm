#!/bin/bash

set -e
shopt -s dotglob

basedir="$( cd -P "$( dirname "$0" )" && pwd )"

function fetch_package() {
    local engine="$1"
    local version="$2"
    local location="$3"

    mkdir -p "$location"

    local package="http://paulisageek.com/tmp/hhvm.tgz"

    curl "$package" -L -s -o - | tar xzf - -C "$location"
}

function indent() {
    c='s/^/       /'
    case $(uname) in
        Darwin) sed -l "$c";;
        *)      sed -u "$c";;
    esac
}

function mktmpdir() {
    dir=$(mktemp -t php-$1-XXXX)
    rm -rf $dir
    mkdir -p $dir
    echo $dir
}

BUILD_DIR="$1"
CACHE_DIR="$2"

cd "$BUILD_DIR"

HHVM_VERSION="2.1.0"

echo "-----> Vendoring HHVM ${HHVM_VERSION}"

VENDORED_HHVM=$(mktmpdir hhvm)

fetch_package hhvm "$HHVM_VERSION" "$VENDORED_HHVM"

echo "-----> Vendoring binaries into slug"

[ ! -d "$BUILD_DIR/vendor" ] && mkdir -p "$BUILD_DIR/vendor"

cp -R "$VENDORED_HHVM/" "vendor/hhvm"

cp "$basedir/../conf/config.hdf $VENDORED_HHVM/config.hdf"

# Test that all packages were fetched and extracted successfully
test -d "vendor/hhvm"

if [ -n "$BUILDPACK_DEBUG" ]; then
    ls -R vendor/hhvm
fi
