#!/bin/bash

set -e
shopt -s dotglob

basedir="$( cd -P "$( dirname "$0" )" && pwd )"

function fetch_package() {
    local engine="$1"
    local version="$2"
    local location="$3"

    mkdir -p "$location"

    local package="http://paulisageek.com/tmp/hhvm-10.04"

    curl "$package" -L -s -o - | tar xzf - -C "$location"
}

function indent() {
    c='s/^/       /'
    case $(uname) in
        Darwin) sed -l "$c";;
        *)      sed -u "$c";;
    esac
}

function install_composer_deps() {
    local cwd=$(pwd)
    local target="$1"

    echo "-----> Vendoring Composer"
    {
        mkdir -p "$target/vendor/composer/bin"
        curl -L "http://getcomposer.org/composer.phar" > "$target/vendor/composer/bin/composer.phar"
        chmod a+x "$target/vendor/composer/bin/composer.phar"
    } | indent

    echo "-----> Installing application dependencies with Composer"
    {
        cd "$target"
        "$BUILD_DIR/vendor/php/bin/php" \
            "$target/vendor/composer/bin/composer.phar" install \
            --prefer-dist \
            --optimize-autoloader \
            --no-interaction

        cd "$cwd"
    } | indent
}

function mktmpdir() {
    dir=$(mktemp -t php-$1-XXXX)
    rm -rf $dir
    mkdir -p $dir
    echo $dir
}

BUILD_DIR="$1"
CACHE_DIR="$2"

cd "$BUILD_DIR"

DEFAULT_HHVM="2.1.0"

HHVM_VERSION=$(package_hhvm_version)

echo "-----> Vendoring HHVM ${HHVM_VERSION}"

VENDORED_HHVM=$(mktmpdir hhvm)

fetch_package hhvm "$HHVM_VERSION" "$VENDORED_HHVM"

echo "-----> Vendoring binaries into slug"

[ ! -d "$BUILD_DIR/vendor" ] && mkdir -p "$BUILD_DIR/vendor"

cp -R "$VENDORED_HHVM/" "vendor/hhvm"

# Test that all packages were fetched and extracted successfully
test -d "vendor/hhvm"

if [ -n "$BUILDPACK_DEBUG" ]; then
    ls -R vendor/hhvm
fi

install_composer_deps "$BUILD_DIR"
